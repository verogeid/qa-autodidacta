<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini IA con Audiolibros</title>
<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; margin: 1rem; background: #fafafa; }
  #face { width: 120px; height: 120px; margin: auto; background: #ffcba4; position: relative; border-radius: 20px; }
  #eye-left, #eye-right {
    width: 20px; height: 20px; background: black; border-radius: 50%;
    position: absolute; top: 30px;
  }
  #eye-left { left: 25px; }
  #eye-right { right: 25px; }
  #mouth {
    width: 60px; height: 20px; background: #800000; border-radius: 0 0 30px 30px;
    position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
    transition: height 0.1s;
  }
  #inputText { width: 90%; height: 100px; margin-top: 1rem; font-size: 1rem; }
  #output { margin-top: 1rem; min-height: 50px; background: white; padding: 0.5rem; border-radius: 8px; white-space: pre-wrap; }
  label { margin: 0 1rem; font-size: 0.9rem; }
  select { margin-top: 1rem; font-size: 1rem; padding: 0.3rem; }
  option.read { font-weight: bold; color: green; }
</style>
</head>
<body>

<h1>Mini IA con Audiolibros</h1>

<select id="fileSelector">
  <option value="">Selecciona un archivo</option>
  <option value="lessons/intro.md">Introducción</option>
  <option value="lessons/01-que-es-un-componente-en-react.md">01-¿Qué es un componente en React?</option>
  <option value="lessons/02-jsx.md">02-JSX</option>
  <option value="lessons/03-props.md">03-Props</option>
  <option value="lessons/04-state.md">04-State</option>
  <option value="lessons/05-eventos.md">05-Eventos</option>
  <option value="lessons/06-como-hablar-entre-componentes.md">06-Como hablar entre componentes</option>
  <option value="lessons/07-formularios.md">07-Formularios</option>
  <option value="lessons/08-como-pasan-los-datos-de-un-componente-a-otro.md">08-Cómo pasan los datos de un componente a otro</option>
  <option value="lessons/09-useeffect.md">09-useEffect</option>
  <option value="lessons/10-el-truco-del-limpiador.md">10-El truco del limpiador</option>
  <option value="lessons/11-useref.md">11-useRef</option>
  <option value="lessons/12-usememo-usecallback.md">12-useMemo y useCallback</option>
  <option value="lessons/13-usereducer.md">13-useReducer</option>
  <option value="lessons/14-context.md">14-Context</option>
  <option value="lessons/15-usememo-usecallback-y-rendimiento-sin-obsesiones.md">15-useMemo useCallback y rendimiento sin obsesiones</option>
  <option value="lessons/16-custom-hooks.md">16-Custom Hooks</option>
  <option value="lessons/17-manejo-de-efectos-secundarios-con-useeffect.md">17-Manejo de efectos secundarios con useEffect</option>
  <option value="lessons/18-manejo-de-formularios-con-react-y-librerias.md">18-manejo de formularios con React y librerías</option>
  <option value="lessons/19-gestion-del-estado-global-con-context-api-y-redux.md">19-Gestión del estado global con Context API y Redux</option>
  <option value="lessons/20-optimizacion-y-buenas-practicas.md">20-Optimización y buenas prácticas</option>
  <option value="lessons/epilogo.md">Resumen final</option>
</select>

<div id="face">
  <div id="eye-left"></div>
  <div id="eye-right"></div>
  <div id="mouth"></div>
</div>

<textarea id="inputText" placeholder="Escribe algo o selecciona un archivo..."></textarea><br>

<label><input type="checkbox" id="toggleSpeech" checked> Voz activada</label>
<label><input type="checkbox" id="toggleFace" checked> Mostrar cara</label>

<select id="voiceSelect" title="Selecciona voz para lectura"></select>

<div id="output"></div>

<script>
  const mouth = document.getElementById('mouth');
  const face = document.getElementById('face');
  const inputText = document.getElementById('inputText');
  const output = document.getElementById('output');
  const toggleSpeech = document.getElementById('toggleSpeech');
  const toggleFace = document.getElementById('toggleFace');
  const fileSelector = document.getElementById('fileSelector');
  const voiceSelect = document.getElementById('voiceSelect');

  let voices = [];
  let speaking = false;
  let currentUtterance = null;
  const readFiles = new Set();

  function populateVoices() {
    voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith("es"));
    if (voices.length === 0) {
      voiceSelect.innerHTML = '<option value="">No hay voces en español disponibles</option>';
      return;
    }
    voiceSelect.innerHTML = voices.map((v, i) =>
      `<option value="${i}">${v.name} (${v.lang})</option>`
    ).join("");
    voiceSelect.selectedIndex = 0;
  }

  speechSynthesis.onvoiceschanged = populateVoices;
  populateVoices();

  function animateMouth(on) {
    mouth.style.height = on ? '40px' : '20px';
    mouth.style.transition = on ? 'height 0.2s' : 'height 0.3s';
  }

  function markAsRead(filename) {
    [...fileSelector.options].forEach(opt => {
      if (opt.value === filename) opt.classList.add('read');
    });
    readFiles.add(filename);
  }

  function getNextFile(currentFile) {
    const options = [...fileSelector.options];
    const currentIndex = options.findIndex(o => o.value === currentFile);
    for (let i = currentIndex + 1; i < options.length; i++) {
      const next = options[i].value;
      if (next && !readFiles.has(next)) return next;
    }
    return null;
  }

  function speak(text, onEnd) {
    if (!toggleSpeech.checked || !window.speechSynthesis) return;
    if (speechSynthesis.speaking) speechSynthesis.cancel();

    const utter = new SpeechSynthesisUtterance(text);
    const selectedVoice = voices[voiceSelect.value] || voices[0];
    if (selectedVoice) utter.voice = selectedVoice;
    utter.lang = 'es-ES';
    utter.onstart = () => {
      speaking = true;
      animateMouth(true);
    };
    utter.onend = () => {
      speaking = false;
      animateMouth(false);
      if (onEnd) onEnd();
    };
    currentUtterance = utter;
    speechSynthesis.speak(utter);
  }

  toggleFace.onchange = () => {
    face.style.display = toggleFace.checked ? 'block' : 'none';
  };

  fileSelector.onchange = async function () {
    const filename = this.value;
    if (!filename) return;
    if (speechSynthesis.speaking) speechSynthesis.cancel();
    try {
      const response = await fetch(filename);
      const text = await response.text();
      inputText.value = text;
      output.textContent = '';
      markAsRead(filename);
      if (toggleSpeech.checked) {
        speak(text, () => {
          const next = getNextFile(filename);
          if (next) {
            fileSelector.value = next;
            fileSelector.dispatchEvent(new Event('change'));
          }
        });
      }
    } catch (e) {
      inputText.value = '';
      output.textContent = 'Error al cargar el archivo.';
    }
  };
</script>

</body>
</html>