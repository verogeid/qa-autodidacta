<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini IA con Audiolibros</title>
<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; margin: 1rem; background: #fafafa; }
  #face { width: 120px; height: 120px; margin: auto; background: #ffcba4; position: relative; border-radius: 20px; }
  #eye-left, #eye-right {
    width: 20px; height: 20px; background: black; border-radius: 50%;
    position: absolute; top: 30px;
  }
  #eye-left { left: 25px; }
  #eye-right { right: 25px; }
  #mouth {
    width: 60px; height: 20px; background: #800000; border-radius: 0 0 30px 30px;
    position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
    transition: height 0.1s;
  }
  #inputText { width: 90%; height: 100px; margin-top: 1rem; font-size: 1rem; }
  #output { margin-top: 1rem; min-height: 50px; background: white; padding: 0.5rem; border-radius: 8px; white-space: pre-wrap; }
  label { margin: 0 1rem; font-size: 0.9rem; }
  select, #voiceSelect { margin-top: 1rem; font-size: 1rem; padding: 0.3rem; }
</style>
</head>
<body>

<h1>Mini IA con Audiolibros</h1>

<select id="fileSelector">
  <option value="">Selecciona un archivo</option>
  <option value="lessons/intro.md">Introducción</option>
  <option value="lessons/01-que-es-un-componente-en-react.md">01-¿Qué es un componente en React?</option>
  <option value="lessons/02-jsx.md">02-JSX</option>
  <option value="lessons/03-props.md">03-Props</option>
  <option value="lessons/04-state.md">04-State</option>
  <option value="lessons/05-eventos.md">05-Eventos</option>
  <option value="lessons/06-como-hablar-entre-componentes.md">06-Como hablar entre componentes</option>
  <option value="lessons/07-formularios.md">07-Formularios</option>
  <option value="lessons/08-como-pasan-los-datos-de-un-componente-a-otro.md">08-Cómo pasan los datos de un componente a otro</option>
  <option value="lessons/09-useeffect.md">09-useEffect</option>
  <option value="lessons/10-el-truco-del-limpiador.md">10-El truco del limpiador</option>
  <option value="lessons/11-useref.md">11-useRef</option>
  <option value="lessons/12-usememo-usecallback.md">12-useMemo y useCallback</option>
  <option value="lessons/13-usereducer.md">13-useReducer</option>
  <option value="lessons/14-context.md">14-Context</option>
  <option value="lessons/15-usememo-usecallback-y-rendimiento-sin-obsesiones.md">15-useMemo useCallback y rendimiento sin obsesiones</option>
  <option value="lessons/16-custom-hooks.md">16-Custom Hooks</option>
  <option value="lessons/17-manejo-de-efectos-secundarios-con-useeffect.md">17-Manejo de efectos secundarios con useEffect</option>
  <option value="lessons/18-manejo-de-formularios-con-react-y-librerias.md">18-manejo de formularios con React y librerías</option>
  <option value="lessons/19-gestion-del-estado-global-con-context-api-y-redux.md">19-Gestión del estado global con Context API y Redux</option>
  <option value="lessons/20-optimizacion-y-buenas-practicas.md">20-Optimización y buenas prácticas</option>
  <option value="lessons/epilogo.md">Resumen final</option>
</select>

<br>

<select id="voiceSelect">
  <option value="">Selecciona una voz</option>
</select>

<div id="face">
  <div id="eye-left"></div>
  <div id="eye-right"></div>
  <div id="mouth"></div>
</div>

<textarea id="inputText" placeholder="Selecciona un archivo para leer..." readonly></textarea>

<div id="output"></div>

<script>
  const mouth = document.getElementById('mouth');
  const face = document.getElementById('face');
  const inputText = document.getElementById('inputText');
  const output = document.getElementById('output');
  const toggleSpeech = { checked: true }; // voz activada fija
  const fileSelector = document.getElementById('fileSelector');
  const voiceSelect = document.getElementById('voiceSelect');

  let speaking = false;
  let mouthInterval = null;
  let voices = [];
  let currentUtterance = null;

  function animateMouthStart() {
    if (mouthInterval) clearInterval(mouthInterval);
    mouthInterval = setInterval(() => {
      mouth.style.height = mouth.style.height === '20px' ? '40px' : '20px';
    }, 200);
  }

  function animateMouthStop() {
    if (mouthInterval) {
      clearInterval(mouthInterval);
      mouthInterval = null;
    }
    mouth.style.height = '20px';
  }

  function speak(text, onEnd) {
    if (!toggleSpeech.checked || !window.speechSynthesis) return;
    if (speechSynthesis.speaking) speechSynthesis.cancel();

    const utter = new SpeechSynthesisUtterance(text);
    const selectedVoiceIndex = voiceSelect.value;
    const selectedVoice = voices[selectedVoiceIndex] || voices[0];
    if (selectedVoice) utter.voice = selectedVoice;
    utter.lang = selectedVoice?.lang || 'es-ES';

    utter.onstart = () => {
      speaking = true;
      animateMouthStart();
    };
    utter.onend = () => {
      speaking = false;
      animateMouthStop();
      if (onEnd) onEnd();
    };
    utter.onerror = () => {
      speaking = false;
      animateMouthStop();
    };

    currentUtterance = utter;
    speechSynthesis.speak(utter);
  }

  function loadVoices() {
    voices = speechSynthesis.getVoices();
    voiceSelect.innerHTML = '<option value="">Selecciona una voz</option>';
    voices.forEach((voice, i) => {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = `${voice.name} (${voice.lang})`;
      voiceSelect.appendChild(option);
    });
  }

  speechSynthesis.onvoiceschanged = loadVoices;
  loadVoices();

  fileSelector.onchange = async function() {
    const filename = this.value;
    if (!filename) return;
    try {
      const response = await fetch(filename);
      const text = await response.text();
      inputText.value = text;
      output.textContent = text;
      speak(text);
    } catch (e) {
      inputText.value = '';
      output.textContent = 'Error al cargar el archivo.';
    }
  };

  voiceSelect.onchange = () => {
    if (!inputText.value) return;
    if (speechSynthesis.speaking) {
      speechSynthesis.cancel();
    }
    speak(inputText.value);
  };
</script>

</body>
</html>